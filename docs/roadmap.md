# スノージャム検知システム Roadmap (v0.9)

## Phase 1: 基盤・環境
- [x] Docker Compose (Nginx / Frontend / FastAPI / FTP) 構築とボリューム設定(`/ftp_data`, `/storage`, `/config`)。
- [x] 環境変数・秘密情報の整理（Slack Webhook URL / Bot Token、GPIO設定を `.env.local` などで管理）。
- [x] クローン直後に `docker compose up --build` だけでフロントビルドまで完了する構成に簡素化。
- [x] 複数ユーザー同一ホストでもプロジェクト名を自動分離する起動スクリプト追加。

## Phase 2: ストレージとリテンション
- [x] `/ftp_data/incoming` 監視と `/storage/archive/YYYY/MM/DD/` への日付振り分け実装（watchdog + 10秒ポーリング）。
- [x] 90日超データの自動削除タスク（APScheduler, 03:00）と削除ログ出力の土台（スケジューラ起動、削除処理の雛形）。

## Phase 3: 検知パイプライン
- [x] 画像差分パイプライン（ROIマスク → 差分 → 二値化 → ノイズ除去 → 面積判定）。
- [x] 設定ファイル(JSON)読み書き: しきい値、連続検知回数、二値化閾値、ぼかしカーネル、マスク座標。
- [x] 画像到着遅延監視（デフォルト5分でWarning、閾値と有効/無効を設定で変更可能）。
- [x] 検知結果のマスク/オーバーレイPNG生成（ピンク透過で最新画像に重ねるデータ出力）。

## Phase 4: アラート・I/O
- [x] GPIO出力（任意ピン High でブザー駆動）、ラッチ保持とリセットAPI。
- [x] Slack通知（Alarm時の送信、Bot Tokenで画像添付、Webhookのみの場合のテキストフォールバック、メッセージテンプレート定義）。
- [x] ヘルスチェック `/health`（プロセス・ストレージ空き・遅延監視状態）。

## Phase 5: API層
- [x] `GET /api/dashboard`（最新/前回画像パス、検知値、警報状態、遅延状態、オーバーレイPNGパス）。
- [x] `GET /api/history`（直近N件サムネイル/パス）。
- [x] `POST /api/config`（検知・遅延監視・Slack Webhook・GPIOピン設定）。
- [x] `POST /api/control`（警報ON/OFF、リセット）。
- [x] `GET /api/history` の返却整備（オーバーレイ除外のデフォルトと、種別フラグ付与のオプション追加）。

## Phase 6: フロントエンド - ダッシュボード
- [x] React Router導入とルーティング (`/`, `/settings`)。
- [x] 画像表示（最新/1分前/履歴）、警報・遅延ステータス表示、操作ボタン（警報ON/OFF、リセット、遅延監視ON/OFF）。
- [x] 最新画像にピンクの検知オーバーレイを重ねる表示。

## Phase 7: フロントエンド - 設定画面
- [x] パラメータ入力フォーム（しきい値、連続検知回数、二値化閾値、ぼかし、遅延閾値、Slack Webhook、GPIOピン）。
- [x] マスク設定（モノクロ画像アップロード・適用ON/OFFの切替、マスクリセット）。
- [x] 設定のインポート/エクスポート(JSON)。
- [x] オーバーレイ色/不透明度の変更UIと即時反映（キャッシュバスター付き）。

## Phase 8: テスト・キャリブレーション
- [ ] ユニットテスト（差分・二値化・面積判定、設定バリデーション、遅延監視）。
- [ ] 結合テスト（画像投入→検知→保存→削除、警報発報→Slack→リセット）。
- [ ] 実画像による初期しきい値キャリブレーション（`SamplePhoto/` 使用、誤検知20%許容で漏れゼロを確認）。
