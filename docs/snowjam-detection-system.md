# スノージャム検知システム設計書 (v0.9)

## 1. 目的と背景
- 導水路にスノージャムが進入すると取水障害が発生し、復旧に大きなリソースが必要となる。
- 進入前に上流ゲートを閉止するため、監視カメラ画像を用いて自動検知・警報を行う。
- カメラは定点設置で照明は固定、`SamplePhoto/` に参考画像を保管（現状はスノージャム無し）。

## 2. スコープと非対象
- スコープ: 導水路画像の自動検知、警報出力、Web UIによる監視とパラメータ調整、データ保持・削除。
- 非対象: ゲート開閉の自動制御、カメラ側の撮影設定変更、クラウド連携。

## 3. 前提・成功指標
- 前提: Raspberry Pi 5 上でバックエンド実行、ローカルストレージ運用。カメラ画像はFTPで送信され、 nominal 1分間隔だが回線状況で遅延する可能性あり（1分より短くなる想定はなし）。
- 成功指標: 検知レイテンシ1分以内、**未検知(漏れ)ゼロ**を目標、誤検知は最大20%を許容。障害時は警報とログで調査可能。遅延監視をデフォルト5分でWarning、UIからしきい値変更・有効/無効切替可能とする。

## 4. 全体アーキテクチャ概要
- コンポーネント: カメラ(FTPアップロード) → FastAPI(画像監視・検知) → ストレージ(`/storage/archive/YYYY/MM/DD/`) → Reactダッシュボード → GPIO警報出力 + Slack通知。
- 監視フォルダ: `/ftp_data/incoming` を常時監視し新着画像を取得、検知後に `/storage/archive` へ移動。
- 設定ファイル: `/config/settings.json`（しきい値・警報ON/OFF、オーバーレイ色/不透明度等）、`/config/mask.png`（モノクロマスク）。

## 5. データフロー
1. カメラが `/ftp_data/incoming` に画像を1分ごとに保存。
2. 新着イベントまたはポーリングで取得し、前回画像との差分を検知パイプラインで処理。画像到着遅延が設定値（デフォルト5分）を超えた場合はWarningを出し、ログを記録（閾値と監視有効/無効はUIで設定）。
3. 結果をメモリ・設定ファイルへ反映し、GPIOへ警報信号を出力（ラッチ保持、リセットで解除）。
4. 処理済み画像を `/storage/archive/YYYY/MM/DD/` へ日付別に移動。
5. APScheduler が毎日03:00に90日超の画像を削除。

## 6. リテンションとファイル管理
- 保存期間: 過去90日を上限。日付別フォルダで分割し、1フォルダのファイル数を抑制。
- バッチ削除: 深夜1回のクリーンアップ。削除ログと削除件数を記録。
- 例: `/storage/archive/2025/12/01/image_120000.jpg`

## 7. 検知ロジック
- 比較対象: 最新画像と1分前の画像。
- 手順: マスク(ROI)適用 → 差分抽出 → 二値化 → ノイズ除去（オープニング/クロージング） → 面積判定。
- 判定: 変化面積が設定しきい値を超過、かつ連続N回検知で警報発報。
- 調整パラメータ: しきい値、連続検知回数、平滑化カーネル、二値化閾値、マスク適用ON/OFF、オーバーレイ色/不透明度。Web UIで即時反映。
- ロバスト性: 定点・固定照明前提だが、露光ぶれや水面反射に備え、差分の局所平滑化と最小面積フィルタを適用。

## 8. 警報・制御仕様
- 状態: `Normal / Alarm`（遅延監視によるWarningは別フラグで表示）。出力: GPIOラッチで警報保持。デフォルトは物理ピン11（GPIO17）をHigh駆動する実装とし、設定で変更可能（未設定時は無効）。リセットAPI/ボタンで解除。警報ON/OFFの全体スイッチを用意し、メンテナンス時は無効化。
- 通知: Alarm発生時に Slack へ通知。最新画像を添付し、時刻・検知値・しきい値・遅延秒数（遅延時のみ）を含める。画像添付は Slack Web API（Bot Token + `files.upload`）、Webhookのみの場合はテキスト通知にフォールバック。
- ログ: 発報・解除・設定変更をタイムスタンプ付きで記録し、最新50件はダッシュボードで表示。

## 9. Web UI
- 監視ダッシュボード:
- 画像: 最新（素の画像とオーバーレイ画像の2枚）、1分前、直近3枚の履歴（サムネイル）。クリックでライトボックス拡大。
- オーバーレイ: 最新画像上に検知ピクセルを設定色で表示。APIが返すオーバーレイPNGを使用し、色/不透明度は設定値を反映。
  - 指標: 現在の検知値(変化率%)、しきい値、警報状態、保存先パス。
  - 操作: 警報ON/OFF、警報リセット、最新状態の手動更新、画像到着遅延監視のON/OFFとしきい値（デフォルト5分）設定。
- 設定画面（認証なし運用想定）:
  - 数値設定: しきい値、連続検知回数、二値化閾値、ぼかしカーネルサイズ、オーバーレイ色/不透明度等。
  - マスク設定: モノクロPNG/JPEGをアップロード（白=検出対象）。マスク適用ON/OFF切替とリセット、プレビューを提供。
  - 設定インポート/エクスポート: JSONでバックアップ・復元。編集中は自動同期を一時停止し、保存後に再同期。

## 10. 設定パラメータ例
- `threshold`: 変化面積の最小割合 (%)
- `consecutive_hits`: 警報とする連続検知回数
- `binary_threshold`: 二値化閾値
- `blur_kernel`: ぼかしカーネルサイズ (奇数)
- `mask`: モノクロPNG（白=対象）。`mask_inclusive=false` の場合は無視して全域検出。
- `overlay_color`: オーバーレイ色（例: "#ff69b4"）
- `overlay_alpha`: オーバーレイ不透明度(0-1)
- `alarm_enabled`: 警報機能の有効/無効

### 初期値（合意済み）
- `threshold`: 0.15
- `consecutive_hits`: 3
- `binary_threshold`: 30
- `blur_kernel`: 3
- `overlay_color`: "#ff69b4"
- `overlay_alpha`: 0.35
- `delay_monitor_enabled`: true
- `delay_threshold_seconds`: 300
- `alarm_enabled`: true
- `slack_webhook_url`: ""（空なら通知無効）
- `slack_bot_token`: ""（空なら画像添付は無効）
- `gpio_pin`: 17（物理ピン11。未設定/nullならGPIO無効）

## 11. 運用・監視
- ヘルスチェック: APIの `/health` を用意し、プロセス死活とストレージ空き容量を監視。
- ログ/メトリクス: 検知値推移、発報回数、削除件数を記録し、必要に応じて外部へ転送。
- バックアップ: `config/` 配下を定期的にバックアップ。画像は90日保持のみで長期保管しない。
- フェイルセーフ: 検知不能（画像未到着・処理失敗）時は警報ON/OFF設定に関わらずWarningを出し、UIとログで通知。画像到着遅延監視の有効/無効と閾値はUIから変更可（デフォルト5分）。

## 12. テスト方針
- ユニット: 差分・二値化・面積判定、マスク適用、設定バリデーション。
- 結合: 新着画像投入→検知→保存→削除までの一連フロー。
- UI: 主要コンポーネントのスナップショット/DOMテスト、マスク描画の座標保存テスト。
- 実画像検証: `SamplePhoto/` を用いた誤検知確認と基準値の初期キャリブレーション。スノージャム実画像が得られ次第、回帰テストに追加。

## 13. 非機能要件
- パフォーマンス: 画像1枚あたり処理時間 < 5秒 (Raspberry Pi 5)。
- 可用性: 自動再起動とプロセス監視で無人運転を想定。
- セキュリティ: 認証なし運用のため、ネットワークは閉域/LAN内でのアクセスに限定。秘密情報は `.env.local` 等に保持しリポジトリへ含めない。

## 14. デプロイと運用手順の指針
- 推奨: Docker Compose で Nginx/Frontend/FastAPI/FTP を起動し、`/ftp_data` と `/storage` をボリュームマウント。
- 起動後タスク: `config/settings.json` 初期化、マスク描画、警報ON/OFFの確認、削除バッチの実行時間確認。
- メンテナンス: ソフト更新時は警報無効化→更新→動作確認→有効化の順に行う。

## 15. リスクと対策
- 誤検知: 露光ぶれ・水面反射・虫影響 → マスク強化と連続検知回数で抑制。
- 未検知: スノージャムが少量で発生 → しきい値を段階的に低くした Warning で早期検知。
- ストレージ圧迫: 削除バッチ失敗時のため、空き容量監視とアラートを実施。

## 16. 未決事項（要確認）
- なし（現時点での追加確認事項はありません）。
